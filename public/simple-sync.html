<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>简单数据同步</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="test-storage.js"></script>
  <script src="multi-device-sync.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- 头部 -->
  <header class="bg-gradient-to-r from-primary to-secondary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <img src="assets/ShanDa.png" alt="Logo" class="h-10 flex-shrink-0">
        <h1 class="text-2xl font-bold font-stzhongsong truncate md:text-2xl text-lg">简单数据同步</h1>
      </div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-center">多设备数据同步</h1>
      
      <!-- 说明 -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h2 class="text-lg font-semibold text-blue-900 mb-2">使用说明</h2>
        <p class="text-blue-800 text-sm">
          这个页面提供了最简单的数据同步方式。您可以导出当前数据到文件，然后在其他设备上导入这个文件。
        </p>
      </div>
      
      <!-- 操作区域 -->
      <div class="grid md:grid-cols-2 gap-6">
        
        <!-- 导出数据 -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-semibold mb-4 text-green-700">
            <i class="fa fa-download mr-2"></i>导出数据
          </h3>
          <p class="text-gray-600 mb-4">将当前网页的所有数据导出为文件，方便在其他设备上使用。</p>
          
          <button id="export-btn" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">
            <i class="fa fa-download mr-2"></i>导出数据文件
          </button>
          
          <div id="export-status" class="mt-3 text-sm"></div>
        </div>
        
        <!-- 导入数据 -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-semibold mb-4 text-blue-700">
            <i class="fa fa-upload mr-2"></i>导入数据
          </h3>
          <p class="text-gray-600 mb-4">从其他设备导出的文件中导入数据到当前网页。</p>
          
          <input type="file" id="import-file" accept=".json" class="hidden">
          <button id="import-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fa fa-upload mr-2"></i>选择文件导入
          </button>
          
          <div id="import-status" class="mt-3 text-sm"></div>
        </div>
      </div>
      
      <!-- 数据预览 -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h3 class="text-xl font-semibold mb-4">当前数据预览</h3>
        <div id="data-preview" class="bg-gray-50 p-4 rounded-md max-h-64 overflow-y-auto text-sm">
          <!-- 数据预览将在这里显示 -->
        </div>
      </div>
      
      <!-- 操作日志 -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h3 class="text-xl font-semibold mb-4">操作日志</h3>
        <div id="operation-log" class="bg-gray-50 p-4 rounded-md max-h-48 overflow-y-auto text-sm font-mono">
          <!-- 操作日志将在这里显示 -->
        </div>
      </div>
    </div>
  </main>

  <script>
    // 更新状态显示
    function updateStatus(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      const colorClass = type === 'success' ? 'text-green-600' : 
                        type === 'error' ? 'text-red-600' : 'text-blue-600';
      element.innerHTML = `<span class="${colorClass}">${message}</span>`;
    }
    
    // 添加操作日志
    function addLog(message, type = 'info') {
      const logElement = document.getElementById('operation-log');
      const timestamp = new Date().toLocaleTimeString();
      const colorClass = type === 'success' ? 'text-green-600' : 
                        type === 'error' ? 'text-red-600' : 'text-blue-600';
      
      logElement.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    // 更新数据预览
    function updateDataPreview() {
      const previewElement = document.getElementById('data-preview');
      
      try {
        // 获取当前数据
        const currentData = {
          greenAreas: window.greenAreas || {},
          selectedArea: window.selectedArea || '',
          lastModified: new Date().toLocaleString(),
          deviceInfo: {
            userAgent: navigator.userAgent,
            timestamp: Date.now()
          }
        };
        
        const dataStr = JSON.stringify(currentData, null, 2);
        previewElement.innerHTML = `<pre class="text-xs">${dataStr}</pre>`;
        
      } catch (error) {
        previewElement.innerHTML = `<span class="text-red-600">无法获取数据: ${error.message}</span>`;
      }
    }
    
    // 导出数据
    function exportData() {
      try {
        addLog('开始导出数据...', 'info');
        
        // 获取当前数据
        const exportData = {
          greenAreas: window.greenAreas || {},
          selectedArea: window.selectedArea || '',
          nextAreaLetter: window.nextAreaLetter || 'A',
          currentPage: window.currentPage || 1,
          wateringCurrentPage: window.wateringCurrentPage || 1,
          exportTime: new Date().toISOString(),
          version: '1.0'
        };
        
        // 创建文件
        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // 下载文件
        const a = document.createElement('a');
        a.href = url;
        a.download = `绿化数据_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        updateStatus('export-status', '✅ 数据导出成功！', 'success');
        addLog('数据导出成功', 'success');
        
      } catch (error) {
        updateStatus('export-status', `❌ 导出失败: ${error.message}`, 'error');
        addLog(`导出失败: ${error.message}`, 'error');
      }
    }
    
    // 导入数据
    function importData(file) {
      try {
        addLog('开始导入数据...', 'info');
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedData = JSON.parse(e.target.result);
            
            // 验证数据格式
            if (!importedData.greenAreas) {
              throw new Error('文件格式不正确，缺少绿化区域数据');
            }
            
            // 更新数据
            window.greenAreas = importedData.greenAreas || {};
            window.selectedArea = importedData.selectedArea || '';
            window.nextAreaLetter = importedData.nextAreaLetter || 'A';
            window.currentPage = importedData.currentPage || 1;
            window.wateringCurrentPage = importedData.wateringCurrentPage || 1;
            
            // 保存到本地存储
            if (window.testStorage) {
              const saveData = {
                greenAreas: window.greenAreas,
                selectedArea: window.selectedArea,
                nextAreaLetter: window.nextAreaLetter,
                currentPage: window.currentPage,
                wateringCurrentPage: window.wateringCurrentPage
              };
              window.testStorage.saveData(saveData);
            }
            
            updateStatus('import-status', '✅ 数据导入成功！', 'success');
            addLog('数据导入成功', 'success');
            
            // 更新预览
            updateDataPreview();
            
            // 提示用户刷新页面
            setTimeout(() => {
              if (confirm('数据导入成功！建议刷新页面以应用新数据。是否现在刷新？')) {
                window.location.reload();
              }
            }, 1000);
            
          } catch (error) {
            updateStatus('import-status', `❌ 导入失败: ${error.message}`, 'error');
            addLog(`导入失败: ${error.message}`, 'error');
          }
        };
        
        reader.readAsText(file);
        
      } catch (error) {
        updateStatus('import-status', `❌ 导入失败: ${error.message}`, 'error');
        addLog(`导入失败: ${error.message}`, 'error');
      }
    }
    
    // 页面加载完成
    document.addEventListener('DOMContentLoaded', () => {
      addLog('页面加载完成', 'info');
      
      // 更新数据预览
      updateDataPreview();
      
      // 导出按钮事件
      document.getElementById('export-btn').addEventListener('click', exportData);
      
      // 导入按钮事件
      document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('import-file').click();
      });
      
      // 文件选择事件
      document.getElementById('import-file').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          importData(file);
          // 清空文件输入
          e.target.value = '';
        }
      });
    });
  </script>
</body>
</html> 